{"version":3,"file":"error.js","sources":["../../src/middleware/error.ts"],"sourcesContent":["import path from 'node:path';\n\nimport ansiHtml from 'ansi-html';\nimport { htmlEscape } from 'escape-goat';\nimport { type Connect } from 'vite';\n\nimport TEMPLATE_ERROR_HTML from '../template/error.html?raw';\nimport { createDebugger } from '../util/create-debugger.js';\nimport { CLIENT_SCRIPT_NAME } from './client.js';\n\ninterface Options {\n  readonly base: string;\n  readonly getError: () => Error | undefined;\n}\n\n/**\n * Middleware that serves an error page when an error is present.\n */\nexport default ({ base, getError }: Options): Connect.NextHandleFunction => {\n  const debug = createDebugger('live-preview');\n  const clientSrc = JSON.stringify(path.posix.join(base, CLIENT_SCRIPT_NAME));\n\n  return (req, res, next) => {\n    const error = getError();\n\n    if (!error) return next();\n\n    if (!req.headers.accept?.includes('html')) {\n      res.statusCode = 500;\n      res.end();\n      debug?.(`served empty error response for \"${req.url}\".`);\n\n      return;\n    }\n\n    const message = ansiHtml(htmlEscape(error.message));\n    const html = TEMPLATE_ERROR_HTML\n      .replace(/(?=<\\/head>)|$/iu, `<script crossorigin=\"\" src=${clientSrc}></script>\\n`)\n      .replace(/(?=<\\/body>)|$/iu, `<pre class=\"error\"><code>${message}</code></pre>\\n`);\n\n    res.statusCode = 500;\n    res.setHeader('Content-Type', 'text/html');\n    res.setHeader('Content-Length', Buffer.byteLength(html, 'utf8'));\n    res.end(html);\n    debug?.(`served error page for \"${req.url}\".`);\n  };\n};\n"],"names":[],"mappings":";;;;;;;AAkBA,wBAAe,CAAC,EAAE,IAAM,EAAA,QAAA,EAAoD,KAAA;AAC1E,EAAM,MAAA,KAAA,GAAQ,eAAe,cAAc,CAAA,CAAA;AAC3C,EAAM,MAAA,SAAA,GAAY,KAAK,SAAU,CAAA,IAAA,CAAK,MAAM,IAAK,CAAA,IAAA,EAAM,kBAAkB,CAAC,CAAA,CAAA;AAE1E,EAAO,OAAA,CAAC,GAAK,EAAA,GAAA,EAAK,IAAS,KAAA;AACzB,IAAA,MAAM,QAAQ,QAAS,EAAA,CAAA;AAEvB,IAAA,IAAI,CAAC,KAAA;AAAO,MAAA,OAAO,IAAK,EAAA,CAAA;AAExB,IAAA,IAAI,CAAC,GAAI,CAAA,OAAA,CAAQ,MAAQ,EAAA,QAAA,CAAS,MAAM,CAAG,EAAA;AACzC,MAAA,GAAA,CAAI,UAAa,GAAA,GAAA,CAAA;AACjB,MAAA,GAAA,CAAI,GAAI,EAAA,CAAA;AACR,MAAQ,KAAA,GAAA,CAAA,iCAAA,EAAoC,GAAI,CAAA,GAAG,CAAI,EAAA,CAAA,CAAA,CAAA;AAEvD,MAAA,OAAA;AAAA,KACF;AAEA,IAAA,MAAM,OAAU,GAAA,QAAA,CAAS,UAAW,CAAA,KAAA,CAAM,OAAO,CAAC,CAAA,CAAA;AAClD,IAAA,MAAM,IAAO,GAAA,mBAAA,CACV,OAAQ,CAAA,kBAAA,EAAoB,8BAA8B,SAAS,CAAA;AAAA,CAAc,CACjF,CAAA,OAAA,CAAQ,kBAAoB,EAAA,CAAA,yBAAA,EAA4B,OAAO,CAAA;AAAA,CAAiB,CAAA,CAAA;AAEnF,IAAA,GAAA,CAAI,UAAa,GAAA,GAAA,CAAA;AACjB,IAAI,GAAA,CAAA,SAAA,CAAU,gBAAgB,WAAW,CAAA,CAAA;AACzC,IAAA,GAAA,CAAI,UAAU,gBAAkB,EAAA,MAAA,CAAO,UAAW,CAAA,IAAA,EAAM,MAAM,CAAC,CAAA,CAAA;AAC/D,IAAA,GAAA,CAAI,IAAI,IAAI,CAAA,CAAA;AACZ,IAAQ,KAAA,GAAA,CAAA,uBAAA,EAA0B,GAAI,CAAA,GAAG,CAAI,EAAA,CAAA,CAAA,CAAA;AAAA,GAC/C,CAAA;AACF,CAAA;;;;"}