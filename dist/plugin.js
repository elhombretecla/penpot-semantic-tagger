penpot.ui.open("Semantic Tagging",`?theme=${penpot.theme}`,{width:320,height:600});let u=new Map;function w(){b(),d()}function b(){try{u.clear(),penpot.ui.sendMessage({source:"penpot",type:"tags-loaded",data:Array.from(u.values())})}catch(o){console.warn("Error loading existing tags:",o)}}function l(){try{console.log("Tags saved in memory:",u.size)}catch(o){console.error("Error saving tags:",o)}}function d(){const r=penpot.selection.map(t=>({id:t.id,name:t.name||"Unnamed",type:t.type}));penpot.ui.sendMessage({source:"penpot",type:"selection-update",data:r})}function $(o){const r={};try{if((o==null?void 0:o.x)!==void 0&&o.x!==null&&typeof o.x=="number"&&(r.left=`${o.x}px`),(o==null?void 0:o.y)!==void 0&&o.y!==null&&typeof o.y=="number"&&(r.top=`${o.y}px`),o!=null&&o.width&&typeof o.width=="number"&&(r.width=`${o.width}px`),o!=null&&o.height&&typeof o.height=="number"&&(r.height=`${o.height}px`),o!=null&&o.fills&&Array.isArray(o.fills)&&o.fills.length>0){const t=o.fills[0];if(t!=null&&t.fillColor&&typeof t.fillColor=="object"){const{r:a,g:s,b:n,alpha:f=1}=t.fillColor;typeof a=="number"&&typeof s=="number"&&typeof n=="number"&&(r.backgroundColor=`rgba(${Math.round(a*255)}, ${Math.round(s*255)}, ${Math.round(n*255)}, ${f})`)}}if(o!=null&&o.fontFamily&&typeof o.fontFamily=="string"&&(r.fontFamily=o.fontFamily),o!=null&&o.fontSize&&typeof o.fontSize=="number"&&(r.fontSize=`${o.fontSize}px`),(o==null?void 0:o.fontWeight)!==void 0&&o.fontWeight!==null&&(r.fontWeight=String(o.fontWeight)),o!=null&&o.textAlign&&typeof o.textAlign=="string"&&(r.textAlign=o.textAlign),(o==null?void 0:o.lineHeight)!==void 0&&o.lineHeight!==null&&(r.lineHeight=String(o.lineHeight)),o!=null&&o.fontColor&&typeof o.fontColor=="object"){const{r:t,g:a,b:s,alpha:n=1}=o.fontColor;typeof t=="number"&&typeof a=="number"&&typeof s=="number"&&(r.color=`rgba(${Math.round(t*255)}, ${Math.round(a*255)}, ${Math.round(s*255)}, ${n})`)}if(o!=null&&o.rx&&typeof o.rx=="number"||o!=null&&o.ry&&typeof o.ry=="number"){const t=o.rx||o.ry||0;r.borderRadius=`${t}px`}if((o==null?void 0:o.opacity)!==void 0&&o.opacity!==null&&typeof o.opacity=="number"&&o.opacity!==1&&(r.opacity=String(o.opacity)),o!=null&&o.strokes&&Array.isArray(o.strokes)&&o.strokes.length>0){const t=o.strokes[0];if(t!=null&&t.strokeColor&&(t!=null&&t.strokeWidth)&&typeof t.strokeWidth=="number"){const{r:a,g:s,b:n,alpha:f=1}=t.strokeColor;if(typeof a=="number"&&typeof s=="number"&&typeof n=="number"){const g=`rgba(${Math.round(a*255)}, ${Math.round(s*255)}, ${Math.round(n*255)}, ${f})`;r.border=`${t.strokeWidth}px solid ${g}`}}}if(o!=null&&o.shadows&&Array.isArray(o.shadows)&&o.shadows.length>0){const t=o.shadows[0];if(t!=null&&t.color&&(t==null?void 0:t.offsetX)!==void 0&&t.offsetX!==null){const{r:a,g:s,b:n,alpha:f=1}=t.color;if(typeof a=="number"&&typeof s=="number"&&typeof n=="number"){const g=`rgba(${Math.round(a*255)}, ${Math.round(s*255)}, ${Math.round(n*255)}, ${f})`,h=t.blur||0,y=t.spread||0;r.boxShadow=`${t.offsetX}px ${t.offsetY||0}px ${h}px ${y}px ${g}`}}}}catch(t){console.warn("Error extracting styles:",t)}return r}function M(o){const r={};try{if((o==null?void 0:o.type)==="text"&&(o!=null&&o.characters)&&typeof o.characters=="string"&&(r.content=o.characters),(o==null?void 0:o.type)==="image"&&(o!=null&&o.imageData)){const t=o!=null&&o.name&&typeof o.name=="string"?o.name:"image";r.imageUrl=`assets/${t}.png`}}catch(t){console.warn("Error extracting content:",t)}return r}function e(o){const r={};try{if(!(o!=null&&o.children)||!Array.isArray(o.children)||o.children.length===0)return r;const t=o.children;if(t.length>1){const a=t.filter(i=>i&&typeof i.x=="number"&&typeof i.y=="number"&&typeof i.width=="number"&&typeof i.height=="number").map(i=>({x:i.x,y:i.y,width:i.width,height:i.height}));if(a.length<2)return r;const s=[...a].sort((i,p)=>i.x-p.x),n=[...a].sort((i,p)=>i.y-p.y),f=a.map(i=>i.y),g=a.map(i=>i.x),h=Math.max(...f)-Math.min(...f),y=Math.max(...g)-Math.min(...g);if(h<20&&y>50){if(r.display="flex",r.flexDirection="row",s.length>1){const i=[];for(let p=1;p<s.length;p++){const c=s[p].x-(s[p-1].x+s[p-1].width);c>0&&i.push(c)}if(i.length>0){const p=i.reduce((c,x)=>c+x,0)/i.length;r.gap=`${Math.round(p)}px`}}}else if(y<20&&h>50&&(r.display="flex",r.flexDirection="column",n.length>1)){const i=[];for(let p=1;p<n.length;p++){const c=n[p].y-(n[p-1].y+n[p-1].height);c>0&&i.push(c)}if(i.length>0){const p=i.reduce((c,x)=>c+x,0)/i.length;r.gap=`${Math.round(p)}px`}}if(r.display==="flex"&&a.length>0){if(r.flexDirection==="column"){const i=a.every(c=>Math.abs(c.x-a[0].x)<10),p=a.every(c=>Math.abs(c.x+c.width/2-(a[0].x+a[0].width/2))<10);i?r.alignItems="flex-start":p?r.alignItems="center":r.alignItems="flex-start"}if(r.flexDirection==="row"){const i=a.every(c=>Math.abs(c.y-a[0].y)<10),p=a.every(c=>Math.abs(c.y+c.height/2-(a[0].y+a[0].height/2))<10);i?r.alignItems="flex-start":p?r.alignItems="center":r.alignItems="flex-start"}}}}catch(t){console.warn("Error analyzing layout:",t)}return r}function v(o,r,t){t.forEach(a=>{var n;const s=(n=penpot.currentPage)==null?void 0:n.getShapeById(a);if(s){const f=$(s),{content:g,imageUrl:h}=M(s),y=e(s),i={tag:o,properties:r,elementId:a,elementName:s.name||"Unnamed",elementType:s.type,styles:f,layout:Object.keys(y).length>0?y:void 0,content:g,imageUrl:h,children:[]};u.set(a,i),penpot.ui.sendMessage({source:"penpot",type:"tag-applied",data:i})}}),l()}function A(o){o.forEach(r=>{var a;((a=penpot.currentPage)==null?void 0:a.getShapeById(r))&&(u.delete(r),penpot.ui.sendMessage({source:"penpot",type:"tag-removed",data:{elementId:r}}))}),l()}function S(){const o=Array.from(u.values()),r=new Map,t=[];return o.forEach(a=>{var n;const s=(n=penpot.currentPage)==null?void 0:n.getShapeById(a.elementId);if(s){const f=$(s),{content:g,imageUrl:h}=M(s),y=e(s),i={...a,elementType:s.type,styles:f,layout:Object.keys(y).length>0?y:void 0,content:g,imageUrl:h,children:[]};r.set(a.elementId,i)}}),r.forEach((a,s)=>{var f;const n=(f=penpot.currentPage)==null?void 0:f.getShapeById(s);if(n&&n.parent){const g=r.get(n.parent.id);g?g.children.push(a):t.push(a)}else t.push(a)}),t}function E(){var a,s;const o=S(),r=Array.from(u.values()),t={metadata:{pluginName:"Semantic Tagging Plugin",version:"2.0.0",exportDate:new Date().toISOString(),fileName:((a=penpot.currentFile)==null?void 0:a.name)||"Untitled",pageName:((s=penpot.currentPage)==null?void 0:s.name)||"Untitled Page",totalElements:r.length,description:"Enhanced export with tree structure, styles, content, and layout information"},tree:o};penpot.ui.sendMessage({source:"penpot",type:"export-data",data:t})}penpot.ui.onMessage(o=>{switch(o.type){case"get-selection":d();break;case"apply-tag":o.data&&v(o.data.tag,o.data.properties,o.data.elementIds);break;case"remove-tag":o.data&&A(o.data.elementIds);break;case"export-tags":E();break;default:console.warn("Unrecognized message:",o.type)}});penpot.on("selectionchange",()=>{d()});penpot.on("themechange",o=>{penpot.ui.sendMessage({source:"penpot",type:"themechange",theme:o})});penpot.on("pagechange",()=>{b(),d()});penpot.on("filechange",()=>{u.clear(),b(),d()});w();
