penpot.ui.open("Semantic Tagging",`?theme=${penpot.theme}`,{width:320,height:600});let h=new Map;function M(){b(),y()}function b(){try{h.clear(),penpot.ui.sendMessage({source:"penpot",type:"tags-loaded",data:Array.from(h.values())})}catch(t){console.warn("Error loading existing tags:",t)}}function l(){try{console.log("Tags saved in memory:",h.size)}catch(t){console.error("Error saving tags:",t)}}function y(){const o=penpot.selection.map(r=>({id:r.id,name:r.name||"Unnamed",type:r.type}));penpot.ui.sendMessage({source:"penpot",type:"selection-update",data:o})}function x(t){const o={};try{if((t==null?void 0:t.x)!==void 0&&t.x!==null&&typeof t.x=="number"&&(o.left=`${t.x}px`),(t==null?void 0:t.y)!==void 0&&t.y!==null&&typeof t.y=="number"&&(o.top=`${t.y}px`),t!=null&&t.width&&typeof t.width=="number"&&(o.width=`${t.width}px`),t!=null&&t.height&&typeof t.height=="number"&&(o.height=`${t.height}px`),t!=null&&t.fills&&Array.isArray(t.fills)&&t.fills.length>0){const r=t.fills[0];if(r!=null&&r.fillColor&&typeof r.fillColor=="object"){const{r:a,g:i,b:n,alpha:p=1}=r.fillColor;typeof a=="number"&&typeof i=="number"&&typeof n=="number"&&(o.backgroundColor=`rgba(${Math.round(a*255)}, ${Math.round(i*255)}, ${Math.round(n*255)}, ${p})`)}}if(t!=null&&t.fontFamily&&typeof t.fontFamily=="string"&&(o.fontFamily=t.fontFamily),t!=null&&t.fontSize&&typeof t.fontSize=="number"&&(o.fontSize=`${t.fontSize}px`),(t==null?void 0:t.fontWeight)!==void 0&&t.fontWeight!==null&&(o.fontWeight=String(t.fontWeight)),t!=null&&t.textAlign&&typeof t.textAlign=="string"&&(o.textAlign=t.textAlign),(t==null?void 0:t.lineHeight)!==void 0&&t.lineHeight!==null&&(o.lineHeight=String(t.lineHeight)),t!=null&&t.fontColor&&typeof t.fontColor=="object"){const{r,g:a,b:i,alpha:n=1}=t.fontColor;typeof r=="number"&&typeof a=="number"&&typeof i=="number"&&(o.color=`rgba(${Math.round(r*255)}, ${Math.round(a*255)}, ${Math.round(i*255)}, ${n})`)}if(t!=null&&t.rx&&typeof t.rx=="number"||t!=null&&t.ry&&typeof t.ry=="number"){const r=t.rx||t.ry||0;o.borderRadius=`${r}px`}if((t==null?void 0:t.opacity)!==void 0&&t.opacity!==null&&typeof t.opacity=="number"&&t.opacity!==1&&(o.opacity=String(t.opacity)),t!=null&&t.strokes&&Array.isArray(t.strokes)&&t.strokes.length>0){const r=t.strokes[0];if(r!=null&&r.strokeColor&&(r!=null&&r.strokeWidth)&&typeof r.strokeWidth=="number"){const{r:a,g:i,b:n,alpha:p=1}=r.strokeColor;if(typeof a=="number"&&typeof i=="number"&&typeof n=="number"){const e=`rgba(${Math.round(a*255)}, ${Math.round(i*255)}, ${Math.round(n*255)}, ${p})`;o.border=`${r.strokeWidth}px solid ${e}`}}}if(t!=null&&t.shadows&&Array.isArray(t.shadows)&&t.shadows.length>0){const r=t.shadows[0];if(r!=null&&r.color&&(r==null?void 0:r.offsetX)!==void 0&&r.offsetX!==null){const{r:a,g:i,b:n,alpha:p=1}=r.color;if(typeof a=="number"&&typeof i=="number"&&typeof n=="number"){const e=`rgba(${Math.round(a*255)}, ${Math.round(i*255)}, ${Math.round(n*255)}, ${p})`,u=r.blur||0,g=r.spread||0;o.boxShadow=`${r.offsetX}px ${r.offsetY||0}px ${u}px ${g}px ${e}`}}}}catch(r){console.warn("Error extracting styles:",r)}return o}function w(t){const o={};try{if((t==null?void 0:t.type)==="text"&&(t!=null&&t.characters)&&typeof t.characters=="string"&&(o.content=t.characters),(t==null?void 0:t.type)==="image"&&(t!=null&&t.imageData)){const r=t!=null&&t.name&&typeof t.name=="string"?t.name:"image";o.imageUrl=`assets/${r}.png`}}catch(r){console.warn("Error extracting content:",r)}return o}function $(t){const o={};try{if(!(t!=null&&t.children)||!Array.isArray(t.children)||t.children.length===0)return o;const r=t.children;if(r.length>1){const a=r.filter(s=>s&&typeof s.x=="number"&&typeof s.y=="number"&&typeof s.width=="number"&&typeof s.height=="number").map(s=>({x:s.x,y:s.y,width:s.width,height:s.height}));if(a.length<2)return o;const i=[...a].sort((s,c)=>s.x-c.x),n=[...a].sort((s,c)=>s.y-c.y),p=a.map(s=>s.y),e=a.map(s=>s.x),u=Math.max(...p)-Math.min(...p),g=Math.max(...e)-Math.min(...e);if(u<20&&g>50){if(o.display="flex",o.flexDirection="row",i.length>1){const s=[];for(let c=1;c<i.length;c++){const f=i[c].x-(i[c-1].x+i[c-1].width);f>0&&s.push(f)}if(s.length>0){const c=s.reduce((f,d)=>f+d,0)/s.length;o.gap=`${Math.round(c)}px`}}}else if(g<20&&u>50&&(o.display="flex",o.flexDirection="column",n.length>1)){const s=[];for(let c=1;c<n.length;c++){const f=n[c].y-(n[c-1].y+n[c-1].height);f>0&&s.push(f)}if(s.length>0){const c=s.reduce((f,d)=>f+d,0)/s.length;o.gap=`${Math.round(c)}px`}}if(o.display==="flex"&&a.length>0){if(o.flexDirection==="column"){const s=a.every(f=>Math.abs(f.x-a[0].x)<10),c=a.every(f=>Math.abs(f.x+f.width/2-(a[0].x+a[0].width/2))<10);s?o.alignItems="flex-start":c?o.alignItems="center":o.alignItems="flex-start"}if(o.flexDirection==="row"){const s=a.every(f=>Math.abs(f.y-a[0].y)<10),c=a.every(f=>Math.abs(f.y+f.height/2-(a[0].y+a[0].height/2))<10);s?o.alignItems="flex-start":c?o.alignItems="center":o.alignItems="flex-start"}}}}catch(r){console.warn("Error analyzing layout:",r)}return o}function v(t,o,r){r.forEach(a=>{var n;const i=(n=penpot.currentPage)==null?void 0:n.getShapeById(a);if(i){const p=x(i),{content:e,imageUrl:u}=w(i),g=$(i),s={tag:t,properties:o,elementId:a,elementName:i.name||"Unnamed",elementType:i.type,styles:p,layout:Object.keys(g).length>0?g:void 0,content:e,imageUrl:u,children:[]};h.set(a,s),penpot.ui.sendMessage({source:"penpot",type:"tag-applied",data:s})}}),l()}function k(t){t.forEach(o=>{var a;((a=penpot.currentPage)==null?void 0:a.getShapeById(o))&&(h.delete(o),penpot.ui.sendMessage({source:"penpot",type:"tag-removed",data:{elementId:o}}))}),l()}function C(){const t=Array.from(h.values()),o=new Map,r=[];return t.forEach(a=>{var n;const i=(n=penpot.currentPage)==null?void 0:n.getShapeById(a.elementId);if(i){const p=x(i),{content:e,imageUrl:u}=w(i),g=$(i),s={...a,elementType:i.type,styles:p,layout:Object.keys(g).length>0?g:void 0,content:e,imageUrl:u,children:[]};o.set(a.elementId,s)}}),o.forEach((a,i)=>{var p;const n=(p=penpot.currentPage)==null?void 0:p.getShapeById(i);if(n&&n.parent){const e=o.get(n.parent.id);e?e.children.push(a):r.push(a)}else r.push(a)}),r}function A(){var a,i;const t=C(),o=Array.from(h.values()),r={metadata:{pluginName:"Semantic Tagging Plugin",version:"2.0.0",exportDate:new Date().toISOString(),fileName:((a=penpot.currentFile)==null?void 0:a.name)||"Untitled",pageName:((i=penpot.currentPage)==null?void 0:i.name)||"Untitled Page",totalElements:o.length,description:"Enhanced export with tree structure, styles, content, and layout information"},tree:t};penpot.ui.sendMessage({source:"penpot",type:"export-data",data:r})}function S(t){let o=0,r=[];function a(i){if(!i)return;const n=i.name||"",p=E(n);if(p){const e=x(i),{content:u,imageUrl:g}=w(i),s=$(i),c={tag:p.tag,properties:p.properties,elementId:i.id,elementName:i.name||"Unnamed",elementType:i.type,styles:e,layout:Object.keys(s).length>0?s:void 0,content:u,imageUrl:g,children:[]};h.set(i.id,c),r.push(i.id),o++,penpot.ui.sendMessage({source:"penpot",type:"tag-applied",data:c})}i.children&&Array.isArray(i.children)&&i.children.forEach(e=>a(e))}t.forEach(i=>{var p;const n=(p=penpot.currentPage)==null?void 0:p.getShapeById(i);n&&a(n)}),penpot.ui.sendMessage({source:"penpot",type:"auto-tag-complete",data:{taggedCount:o,processedElements:r}}),l()}function E(t){if(!t||t.trim()==="")return null;const o=t.trim().split("/").map(i=>i.trim()).filter(i=>i!=="");if(o.length===0)return null;const r=o[0],a={};switch(r.toLowerCase()){case"input":o[1]&&(a.type=o[1].toLowerCase(),o[2]&&(a.placeholder=o[2]));break;case"button":o[1]&&(a.className=`btn-${o[1].toLowerCase()}`,a.type=o[1].toLowerCase()==="submit"?"submit":"button");break;case"a":o[1]&&(o[1].toLowerCase()==="external"&&(a.target="_blank",a.rel="noopener noreferrer"),o[2]&&(a.href=o[2]));break;case"img":o[1]&&(a.alt=o[1]),o[2]&&(a.src=o[2]);break;case"nav":o[1]&&(a.className=`nav-${o[1].toLowerCase()}`);break;case"div":case"section":case"header":case"footer":case"main":case"aside":o[1]&&(a.className=o[1].toLowerCase().replace(/\s+/g,"-"));break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":o[1]&&(a.className=`heading-${o[1].toLowerCase()}`);break;case"muibutton":o[1]&&(a.variant=o[1].toLowerCase()),o[2]&&(a.color=o[2].toLowerCase());break;case"muitextfield":o[1]&&(a.variant=o[1].toLowerCase()),o[2]&&(a.label=o[2]);break;case"chakrabutton":o[1]&&(a.colorScheme=o[1].toLowerCase()),o[2]&&(a.size=o[2].toLowerCase());break;default:o[1]&&(a.className=o[1].toLowerCase().replace(/\s+/g,"-"));break}return{tag:r,properties:a}}penpot.ui.onMessage(t=>{switch(t.type){case"get-selection":y();break;case"apply-tag":t.data&&v(t.data.tag,t.data.properties,t.data.elementIds);break;case"remove-tag":t.data&&k(t.data.elementIds);break;case"export-tags":A();break;case"auto-tag-selection":t.data&&t.data.elementIds&&S(t.data.elementIds);break;default:console.warn("Unrecognized message:",t.type)}});penpot.on("selectionchange",()=>{y()});penpot.on("themechange",t=>{penpot.ui.sendMessage({source:"penpot",type:"themechange",theme:t})});penpot.on("pagechange",()=>{b(),y()});penpot.on("filechange",()=>{h.clear(),b(),y()});M();
