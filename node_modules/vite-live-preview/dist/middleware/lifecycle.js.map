{"version":3,"file":"lifecycle.js","sources":["../../src/middleware/lifecycle.ts"],"sourcesContent":["import { type Connect } from 'vite';\n\ninterface Options {\n  readonly onRequest: () => () => void;\n}\n\n/**\n * Middleware that invokes lifecycle callbacks.\n */\nexport default ({ onRequest }: Options): Connect.NextHandleFunction => {\n  return (req, res, next) => {\n    let finished = false;\n\n    const callback = onRequest();\n    const onFinish = (): void => {\n      clearTimeout(timeout);\n      if (finished) return;\n      finished = true;\n      callback();\n    };\n\n    // Consider the response finished (timed out) after 5 seconds, even\n    // if the 'finish' event is not emitted.\n    const timeout = setTimeout(onFinish, 5000).unref();\n\n    res.on('finish', onFinish);\n    next();\n  };\n};\n"],"names":[],"mappings":"AASA,4BAAe,CAAC,EAAE,SAAA,EAAqD,KAAA;AACrE,EAAO,OAAA,CAAC,GAAK,EAAA,GAAA,EAAK,IAAS,KAAA;AACzB,IAAA,IAAI,QAAW,GAAA,KAAA,CAAA;AAEf,IAAA,MAAM,WAAW,SAAU,EAAA,CAAA;AAC3B,IAAA,MAAM,WAAW,MAAY;AAC3B,MAAA,YAAA,CAAa,OAAO,CAAA,CAAA;AACpB,MAAI,IAAA,QAAA;AAAU,QAAA,OAAA;AACd,MAAW,QAAA,GAAA,IAAA,CAAA;AACX,MAAS,QAAA,EAAA,CAAA;AAAA,KACX,CAAA;AAIA,IAAA,MAAM,OAAU,GAAA,UAAA,CAAW,QAAU,EAAA,GAAI,EAAE,KAAM,EAAA,CAAA;AAEjD,IAAI,GAAA,CAAA,EAAA,CAAG,UAAU,QAAQ,CAAA,CAAA;AACzB,IAAK,IAAA,EAAA,CAAA;AAAA,GACP,CAAA;AACF,CAAA;;;;"}